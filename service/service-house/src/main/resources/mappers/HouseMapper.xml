<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.rainy.service_house.mapper.HouseMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.rainy.service_house.entity.House">
        <id column="id" property="id"/>
        <result column="title" property="title"/>
        <result column="preview" property="preview"/>
        <result column="detail" property="detail"/>
        <result column="community" property="community"/>
        <result column="street" property="street"/>
        <result column="district" property="district"/>
        <result column="total_price" property="totalPrice"/>
        <result column="unit_price" property="unitPrice"/>
        <result column="room_number" property="roomNumber"/>
        <result column="area" property="area"/>
        <result column="direction" property="direction"/>
        <result column="renovation" property="renovation"/>
        <result column="floor" property="floor"/>
        <result column="year" property="year"/>
        <result column="house_type" property="houseType"/>
        <result column="created" property="created"/>
        <result column="state" property="state"/>
        <result column="deleted" property="deleted"/>
        <result column="rating" property="rating"/>
    </resultMap>

    <resultMap id="BaseResultDetailMap" type="com.rainy.service_house.entity.HouseDetail" extends="BaseResultMap">
        <collection property="images" ofType="com.rainy.service_house.entity.HouseFiles" javaType="list">
            <id column="hfId" jdbcType="BIGINT" property="id"/>
            <result column="imageURL" jdbcType="VARCHAR" property="imageURL"/>
            <result column="type" jdbcType="TINYINT" property="type"/>
        </collection>
    </resultMap>

    <!-- 个人房屋列表查询映射结果 -->
    <resultMap id="HouseListVoResultMap" type="com.rainy.service_house.entity.HouseListVO">
        <id column="id" property="id"/>
        <result column="title" property="title"/>
        <result column="preview" property="preview"/>
        <result column="created" property="created"/>
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, title, preview, detail, community, street, district, total_price, unit_price, room_number, area, direction, renovation, floor, year, house_type, created, state, deleted,rating
    </sql>


    <select id="listById" resultMap="BaseResultDetailMap"
            parameterType="java.lang.Long">
        select h.id,
               h.title,
               h.preview,
               h.detail,
               h.community,
               h.street,
               h.district,
               h.total_price,
               h.unit_price,
               h.room_number,
               h.area,
               h.direction,
               h.renovation,
               h.floor,
               h.year,
               h.house_type,
               h.created,
               h.rating,
               hf.id as hfId,
               hf.imageURL,
               hf.type
        from tb_house h
                 left join tb_house_files hf
                           on h.id = hf.house_id
        where h.deleted = false
          and h.id = #{houseId}
          and hf.deleted = false
    </select>

    <select id="listByHouseQuery" resultMap="HouseListVoResultMap"
            parameterType="com.rainy.service_house.entity.HouseQuery">
        select h.id,
        h.title,
        h.preview,
        h.created,
        h.rating
        from tb_house h
        <where>
            <if test="query.community != null and query.community != '' ">
                and h.community = #{query.community,jdbcType=VARCHAR}
            </if>
            <if test="query.state != null">
                and h.state = #{query.state,jdbcType=TINYINT}
            </if>
        </where>
    </select>


    <select id="listByHouseUserQuery" resultMap="HouseListVoResultMap"
            parameterType="com.rainy.service_house.entity.HouseUserQuery">
        select h.id,
        h.title,
        h.preview,
        h.created,
        h.rating
        from tb_house h
        left join tb_house_user hu
        on h.id = hu.house_id
        <where>
            <if test="query.type != null">
                and hu.user_id = #{query.userId,jdbcType=VARCHAR}
            </if>
            <if test="query.type != null">
                and hu.type = #{query.type,jdbcType=TINYINT}
            </if>
            <if test="query.deleted != null">
                and hu.deleted = #{query.deleted,jdbcType=TINYINT}
                and h.deleted = #{query.deleted,jdbcType=TINYINT}
            </if>
        </where>
    </select>
</mapper>
